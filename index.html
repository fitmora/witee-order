<!doctype html>
<meta charset="utf-8" />
<title>공동구매 주문</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{ --bg:#fafafa;--card:#fff;--bd:#e5e7eb;--muted:#64748b;--em:#0a7cff; --control-h:44px; }
  *{ box-sizing:border-box }
  body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; padding:24px; max-width:960px; margin:auto; background:var(--bg); color:#111; }
  h1{ font-size:22px; margin:0 0 16px }
  fieldset{ border:1px solid var(--bd); border-radius:12px; padding:16px; margin:16px 0; background:var(--card) }
  legend{ padding:0 6px; color:#334155; font-weight:700 }
  label{ display:block; margin:10px 0 6px; font-weight:600 }

  .control{ width:100%; height:var(--control-h); padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; line-height:calc(var(--control-h) - 22px); font-size:16px; appearance:none; }
  input[type="number"].control{ appearance:auto; }
  input[type="number"].control::-webkit-inner-spin-button, input[type="number"].control::-webkit-outer-spin-button{ -webkit-appearance:auto; margin:0; }
  select.control{
    padding-right:28px;
    background-image:linear-gradient(45deg,transparent 50%,#94a3b8 50%),linear-gradient(135deg,#94a3b8 50%,transparent 50%);
    background-position:right 12px top 50%, right 18px top 50%;
    background-size:6px 6px; background-repeat:no-repeat;
  }

  .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .row-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }

  .flex{ display:flex; gap:10px; align-items:center }
  .right{ margin-left:auto }
  .muted{ color:#64748b; font-size:14px }
  .hint{ font-size:12px; color:#475569 }
  button{ padding:12px 16px; border:0; border-radius:10px; background:var(--em); color:#fff; font-weight:700; cursor:pointer }
  button:disabled{ opacity:.5; cursor:not-allowed }
  .btn-ghost{ background:#f1f5f9; color:#0f172a }
  .result{ margin-top:16px }
  .card{ border:1px solid var(--bd); border-radius:12px; padding:16px; margin:16px 0; background:var(--card); box-shadow:0 2px 8px rgba(0,0,0,.05); max-width:960px }
  .card h3{ margin:0 0 12px; font-size:18px }
  .row2{ display:flex; justify-content:space-between; gap:12px; margin:6px 0 }
  .row2 strong{ font-weight:700 }
  .hr{ height:1px; background:#e5e7eb; margin:10px 0 }

  .table{ width:100%; border-collapse:collapse; margin-top:8px }
  .table th,.table td{ padding:8px 10px; border-bottom:1px solid #eee; vertical-align:middle; white-space:nowrap; }
  .table thead th{ text-align:center }
  .table tbody td{ text-align:center }
  .table tbody td:nth-child(2){ text-align:left; white-space:normal }

  .badge-group{ display:inline-block; padding:2px 8px; border-radius:9999px; background:#f1f5f9; color:#334155; font-size:12px; }
  .url{ color:#0a7cff; text-decoration:none; word-break:break-all }
  .subtle{ color:#64748b; font-size:12px }
  .item-box{ border:1px dashed #d1d5db; border-radius:10px; padding:12px; background:#fff }

  .addr-row{ display:flex; gap:8px; align-items:center; white-space:nowrap; }
  .addr-input{ flex:1 1 auto; min-width:0; }
  .addr-btn{ flex:0 0 auto; white-space:nowrap; }

  .item-grid{ display:grid; grid-template-columns:2fr 1fr 1fr 1fr 1fr; gap:12px; grid-template-areas: "url qty size discount notes"; }
  .col-url{ grid-area:url; } .col-qty{ grid-area:qty; } .col-size{ grid-area:size; } .col-discount{ grid-area:discount; } .col-notes{ grid-area:notes; }

  .debug{ display:none; }
  .debug-on .debug{ display:block; }

  .btn-wrap{ display:flex; justify-content:center; }
  .btn-resp{ width:33.333%; }
  .note-text{ text-align:center; margin-top:6px; }

  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; padding:16px; z-index:9999; }
  .modal.open{ display:flex; }
  .modal-card{ width:min(520px, 96vw); background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:hidden; }
  .modal-head{ padding:14px 18px; border-bottom:1px solid #eee; font-weight:700; }
  .modal-body{ padding:18px; color:#0f172a; }
  .modal-actions{ display:flex; gap:10px; justify-content:flex-end; padding:16px 18px; border-top:1px solid #eee; }
  .btn-plain{ background:#e5e7eb; color:#0f172a; }

  @media (max-width: 768px){
    body{ padding:16px; max-width:100%; }
    .card{ max-width:100%; }
    .row-3{ grid-template-columns:1fr; }
    .row{ grid-template-columns:1fr; }
    .item-grid{ grid-template-columns:1fr 1fr 1fr 1fr 1fr; grid-template-areas:
        "url url url url url" "qty size discount notes notes"; }
    .btn-resp{ width:100%; }
    .note-text{ text-align:right; }
  }
</style>

<h1>공동구매 주문</h1>

<fieldset id="buyer_fieldset">
  <legend>주문자 정보</legend>
  <div class="row-3">
    <div>
      <label for="buyer_name">이름 *</label>
      <input id="buyer_name" class="control" type="text" placeholder="킵초게" />
    </div>
    <div>
      <label for="buyer_phone">연락처 *</label>
      <input id="buyer_phone" class="control" type="tel" inputmode="numeric" pattern="[0-9\-]*" maxlength="13" placeholder="010-0000-0000" />
    </div>
    <div>
      <label for="buyer_email">이메일 *</label>
      <input id="buyer_email" class="control" type="email" placeholder="test@example.com" />
    </div>
  </div>
  <div style="margin-top:12px">
    <label for="buyer_addr">주소 *</label>
    <div class="addr-row">
      <input id="buyer_addr" class="control addr-input" type="text" placeholder="도로명 주소" />
      <button id="addr_search" class="btn-ghost addr-btn" type="button">주소 검색</button>
    </div>
    <div class="hint">검색으로 기본 주소를 채운 후 상세주소는 이어서 입력합니다.</div>
  </div>
</fieldset>

<fieldset id="items_fieldset">
  <legend>상품 정보</legend>
  <div id="items"></div>
  <div class="flex" style="margin-top:10px">
    <button id="addItem" class="btn-ghost" type="button">+ 상품 추가</button>
    <span class="right hint">배송 규칙: 전체 수량 기준 <b>3개마다 3,500원</b> 부과</span>
  </div>
</fieldset>

<div class="btn-wrap" style="margin-bottom:4px">
  <button id="btn" type="button" class="btn-resp">주문 검토하기</button>
</div>
<div class="muted note-text">검토 후 주문 정보가 표시됩니다.</div>

<h3 id="reviewHeader" style="display:none">주문 결과</h3>
<div id="result" class="result"></div>
<pre id="out" class="muted debug">아직 요청 전입니다.</pre>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-card">
    <div class="modal-head" id="modalTitle">알림</div>
    <div class="modal-body" id="modalMsg">메시지</div>
    <div class="modal-actions">
      <button id="modalClose" type="button" class="btn-plain">확인</button>
      <button id="modalReset" type="button">처음으로</button>
    </div>
  </div>
</div>

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
/* ===== DEBUG ===== */
const qs = new URLSearchParams(location.search);

const STORAGE_OK = (() => {
  try {
    const k = '__ls_test__';
    window.localStorage.setItem(k, '1');
    window.localStorage.removeItem(k);
    return true;
  } catch (e) {
    return false;
  }
})();

function lsGet(key){
  if (!STORAGE_OK) return null;
  try { return window.localStorage.getItem(key); } catch (e) { return null; }
}
function lsSet(key, val){
  if (!STORAGE_OK) return;
  try { window.localStorage.setItem(key, val); } catch (e) {}
}
function lsRemove(key){
  if (!STORAGE_OK) return;
  try { window.localStorage.removeItem(key); } catch (e) {}
}

function setDebugByUrl(on){
  const u = new URL(location.href);
  if (on) u.searchParams.set('debug', '1');
  else u.searchParams.set('debug', '0');
  location.href = u.toString();
}

const DEBUG = (qs.get('debug') === '1') || (lsGet('DEBUG') === '1');
if (DEBUG) document.documentElement.classList.add('debug-on');

document.addEventListener('keydown', (e) => {
  if (!e.altKey) return;
  if (e.code === 'KeyD' || (e.key && e.key.toLowerCase() === 'd')) {
    if (STORAGE_OK) {
      const on = lsGet('DEBUG') === '1';
      if (on) lsRemove('DEBUG'); else lsSet('DEBUG', '1');
      location.reload();
    } else {
      const on = (new URLSearchParams(location.search)).get('debug') === '1';
      setDebugByUrl(!on);
    }
  }
});

/* ===== 설정 ===== */
const VALIDATE_URL = "https://primary-production-97a64.up.railway.app/webhook/groupbuy/validate";
const SUBMIT_URL   = "https://primary-production-97a64.up.railway.app/webhook/internal-order-feed";
const ADMIN_EMAIL  = "elvina79@gmail.com";

const DISCOUNT_OPTIONS = [
  { key:'',    label:'선택',         mode:null,     value:null },
  { key:'p10', label:'10%',         mode:'percent', value:10 },
  { key:'p20', label:'20%',         mode:'percent', value:20 },
  { key:'p30', label:'30%',         mode:'percent', value:30 },
  { key:'p40', label:'40%',         mode:'percent', value:40 },
  { key:'f230',label:'고정 230,000', mode:'fixed',   value:230000 },
];

/* ===== Dom ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const out = $('#out');
const result = $('#result');
const btn = $('#btn');
const reviewHeader = $('#reviewHeader');
const itemsWrap = $('#items');
const addItemBtn = $('#addItem');

const j = v => JSON.stringify(v, null, 2);
const krw = n => (Number(n||0)).toLocaleString('ko-KR') + '원';
const esc = s => String(s ?? '').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function digitsOnly(s){ return String(s||'').replace(/\D+/g,''); }
function formatPhoneKR(d){
  d = digitsOnly(d);
  if (!d) return '';
  if (d.length <= 3) return d;
  if (d.length <= 7) return d.replace(/(\d{3})(\d+)/, '$1-$2');
  if (d.length === 10) return d.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
  return d.slice(0,11).replace(/(\d{3})(\d{4})(\d{4}).*/, '$1-$2-$3');
}
function setCaretByDigitIndex(inputEl, digitIdx){
  const v = inputEl.value;
  let count = 0, pos = v.length;
  for (let i=0; i<v.length; i++){
    if (/\d/.test(v[i])) count++;
    if (count >= digitIdx){ pos = i+1; break; }
  }
  inputEl.setSelectionRange(pos, pos);
}

/* ===== 모달 ===== */
const modal = $('#modal'), modalMsg = $('#modalMsg');
$('#modalClose').addEventListener('click', ()=>modal.classList.remove('open'));
document.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('open'); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) modal.classList.remove('open'); });
function openModalHTML(html){ modalMsg.innerHTML = html; modal.classList.add('open'); }
function resetForm(){
  $('#buyer_name').value=''; $('#buyer_phone').value=''; $('#buyer_email').value=''; $('#buyer_addr').value='';
  itemsWrap.innerHTML=''; itemsWrap.appendChild(createItemRow(0));
  lastValidated = null; mode='edit';
  setBuyerDisabled(false); setItemsDisabled(false);
  reviewHeader.style.display='none'; result.innerHTML=''; removeConfirmBtn();
  btn.textContent='주문 검토하기'; btn.disabled=false; refreshControls();
  window.scrollTo({ top:0, behavior:'smooth' });
  modal.classList.remove('open');
}
$('#modalReset').addEventListener('click', resetForm);

/* ===== 상태 ===== */
let mode = 'edit';
let lastValidated = null;
let submitting = false;
const MAX_ITEMS = Infinity;

/* ===== 주소 검색 ===== */
function openPostcode() {
  if ($('#addr_search').disabled) return;
  new daum.Postcode({
    oncomplete: function(data) {
      const addr = data.roadAddress || data.address;
      const zone = data.zonecode ? `(${data.zonecode}) ` : '';
      const current = $('#buyer_addr').value.trim();
      $('#buyer_addr').value = zone + addr + (current ? ' ' + current : '');
      $('#buyer_addr').focus();
    }
  }).open();
}
$('#addr_search').addEventListener('click', openPostcode);

/* ===== 전화번호 ===== */
const phoneEl = $('#buyer_phone');
phoneEl.addEventListener('input', () => {
  const raw = phoneEl.value;
  const selStart = phoneEl.selectionStart || 0;
  const digitsBefore = (raw.slice(0, selStart).match(/\d/g) || []).length;
  phoneEl.value = formatPhoneKR(raw);
  setCaretByDigitIndex(phoneEl, digitsBefore);
});

/* ===== 할인 셀렉트 ===== */
function discountSelectHTML(){
  const opts = DISCOUNT_OPTIONS.map(o => `<option value="${o.key}">${o.label}</option>`).join('');
  return `<select name="discount_choice" class="control">${opts}</select>`;
}

/* ===== 아이템 행 ===== */
function createItemRow(idx){
  const el = document.createElement('div');
  el.className = 'item-box';
  el.dataset.idx = idx;
  el.innerHTML = `
    <div class="item-grid">
      <div class="col-url">
        <label>상품 URL *</label>
        <input name="product_url" class="control" type="url" placeholder="https://··· 실제 상품 URL" required />
      </div>
      <div class="col-qty">
        <label>수량 *</label>
        <input name="qty" class="control" type="number" min="1" step="1" value="1" />
      </div>
      <div class="col-size">
        <label>사이즈 *</label>
        <input name="size" class="control" type="text" placeholder="예: 285 / 100" />
      </div>
      <div class="col-discount">
        <label>할인 *</label>
        ${discountSelectHTML()}
      </div>
      <div class="col-notes">
        <label>요청/참고사항</label>
        <input name="notes" class="control" type="text" placeholder="예: 합배송" />
      </div>
    </div>
    <div class="flex" style="margin-top:8px">
      <button type="button" class="btn-ghost remove">– 제거</button>
      <span class="muted">필수: URL / 수량 / 사이즈 / 할인</span>
    </div>
  `;
  el.querySelector('.remove').addEventListener('click', () => {
    if ($$('#items .item-box').length <= 1) return;
    el.remove(); refreshControls();
  });
  return el;
}

/* ===== 컨트롤 ===== */
function refreshControls(){
  const count = $$('#items .item-box').length;
  addItemBtn.disabled = count >= MAX_ITEMS || addItemBtn.dataset.locked === '1';
  $$('#items .item-box .remove').forEach(b => b.disabled = (count <= 1) || (addItemBtn.dataset.locked === '1'));
}
function setBuyerDisabled(disabled){
  ['#buyer_name','#buyer_phone','#buyer_email','#buyer_addr','#addr_search'].forEach(sel=>{
    const el = $(sel); if (el) el.disabled = disabled;
  });
  $('#buyer_fieldset').style.opacity = disabled ? .65 : 1;
}
function setItemsDisabled(disabled){
  $$('#items input, #items select, #items button').forEach(el => { el.disabled = disabled; });
  addItemBtn.dataset.locked = disabled ? '1' : '0';
  $('#items_fieldset').style.opacity = disabled ? .65 : 1;
  refreshControls();
}

/* ===== 초기 ===== */
function initItems(){
  itemsWrap.innerHTML = '';
  itemsWrap.appendChild(createItemRow(0));
  refreshControls();
}
addItemBtn.addEventListener('click', () => {
  if (addItemBtn.dataset.locked === '1') return;
  const count = $$('#items .item-box').length;
  if (count >= MAX_ITEMS) return;
  itemsWrap.appendChild(createItemRow(count));
  refreshControls();
});

/* ===== 페이로드/검증 ===== */
function buildPayload(){
  const buyer = {
    name:   $('#buyer_name').value.trim(),
    phone:  formatPhoneKR($('#buyer_phone').value),
    email:  $('#buyer_email').value.trim(),
    address:$('#buyer_addr').value.trim(),
  };
  const items = $$('#items .item-box').map(box => {
    const $q = s => box.querySelector(s);
    const choiceKey = ($q('select[name="discount_choice"]').value || '').trim();
    const choice = DISCOUNT_OPTIONS.find(o => o.key === choiceKey) || {mode:null, value:null};
    return {
      product_url: ($q('input[name="product_url"]').value || '').trim(),
      qty: Number($q('input[name="qty"]').value || 1),
      size: ($q('input[name="size"]').value || '').trim(),
      notes: ($q('input[name="notes"]').value || '').trim(),
      discount_mode: choice.mode,
      discount_value: choice.value == null ? null : Number(choice.value),
      discount_rate: choice.mode === 'percent' ? Number(choice.value) : null,
      fixed_price:   choice.mode === 'fixed'   ? Number(choice.value) : null,
    };
  });
  return { groups: [{ ...buyer, items }] };
}

function validateRequired(payload){
  const g = payload?.groups?.[0];
  if (!g) return { ok:false, msg:'요청 형식이 올바르지 않습니다.' };
  if (!g.name) return { ok:false, msg:'이름을 입력해 주세요.' };

  const phoneDigits = digitsOnly(g.phone);
  if (!phoneDigits || phoneDigits.length < 10 || phoneDigits.length > 11)
    return { ok:false, msg:'연락처는 숫자 10~11자리로 입력해 주세요.' };

  if (!g.email) return { ok:false, msg:'이메일을 입력해 주세요.' };
  if (!g.address) return { ok:false, msg:'주소를 입력해 주세요.' };

  const items = g.items || [];
  if (!items.length) return { ok:false, msg:'최소 1개 이상의 상품을 추가하세요.' };

  for (let i=0;i<items.length;i++){
    const it = items[i];
    if (!/^https?:\/\//i.test(it.product_url || '')) return { ok:false, msg:`#${i+1} 상품 URL을 http/https로 입력해 주세요.` };
    if (!it.qty || it.qty < 1) return { ok:false, msg:`#${i+1} 수량을 1 이상으로 입력해 주세요.` };
    if (!it.size) return { ok:false, msg:`#${i+1} 사이즈를 입력해 주세요.` };
    if (!it.discount_mode) return { ok:false, msg:`#${i+1} 할인 항목을 선택해 주세요.` };
  }
  return { ok:true };
}

/* ===== 렌더 ===== */
function renderOrderCard(resp){
  result.innerHTML = '';
  if (!resp?.ok){
    const errs = (resp?.errors || []).map(e => esc(e.message)).join('<br>');
    result.innerHTML = `<div class="card"><h3>주문 결과</h3><div class="row2"><div class="muted">${errs || '알 수 없는 오류'}</div></div></div>`;
    removeConfirmBtn(); return;
  }
  const sum = resp.summary || {};
  const g = Array.isArray(resp.groups) ? resp.groups[0] : {items:[]};
  const items = Array.isArray(g.items) ? g.items : [];

  const rows = items.map((it, idx) => {
    const url = String(it.product_url || '').trim();
    const name = esc(it.name || '(상품명 미확인)');
    const opt  = [it.size ? `사이즈: ${esc(it.size)}` : '', it.notes ? `메모: ${esc(it.notes)}` : ''].filter(Boolean).join(' · ');
    const discText = (it.discount_mode === 'fixed') ? '고정'
                    : (it.discount_rate != null && it.discount_rate !== '' ? `${it.discount_rate}%` : '0%');
    const disp = Number(it.display_price ?? it.original_price ?? it.listed_price ?? 0);

    return `
      <tr>
        <td style="display:none">${idx+1}</td>
        <td>
          <div>${name}</div>
          <div class="subtle"><a class="url" href="${esc(url)}" target="_blank" rel="noreferrer">상품 페이지 열기</a></div>
          ${opt ? `<div class="subtle">${opt}</div>` : ''}
        </td>
        <td>${krw(disp)}</td>
        <td>${discText}</td>
        <td>${it.qty || 1}</td>
        <td>${krw(it.total || 0)}</td>
      </tr>`;
  }).join('');

  result.innerHTML = `
    <div class="card">
      <h3>주문 정보</h3>
      <div style="margin-bottom:6px">
        <span class="badge-group">${items.length}개 품목 · 총 수량 ${items.reduce((s,x)=>s+Number(x.qty||0),0)}</span>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th style="display:none">#</th>
            <th>상품명</th>
            <th>가격</th>
            <th>할인</th>
            <th>수량</th>
            <th>소계</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="6" class="subtle">상품 없음</td></tr>`}</tbody>
      </table>

      <div class="hr"></div>
      <div class="row2"><div>상품 합계</div><div>${krw(sum.items_total)}</div></div>
      <div class="row2"><div>배송비</div><div>${krw(sum.shipping_total)}</div></div>
      <div class="hr"></div>
      <div class="row2"><div><strong>총 결제금액</strong></div><div><strong>${krw(sum.grand_total)}</strong></div></div>

      <div class="hr"></div>
      <div class="row2" style="align-items:flex-start">
        <div><strong>입금계좌 정보</strong></div>
        <div style="text-align:right">
          <span class="only-desktop">국민은행 / 819210349569 (예금주: 이민웅)</span>
          <span class="only-mobile" style="display:none; white-space:pre-line">국민은행
819210349569
(예금주: 이민웅)</span>
        </div>
      </div>
    </div>
  `;

  const mql = window.matchMedia('(max-width: 768px)');
  const toggleAcct = () => {
    const mob = mql.matches;
    const d = result.querySelector('.only-desktop');
    const m = result.querySelector('.only-mobile');
    if (!d || !m) return;
    d.style.display = mob ? 'none' : 'inline';
    m.style.display = mob ? 'inline' : 'none';
  };
  toggleAcct();
  mql.addEventListener?.('change', toggleAcct);

  injectConfirmBtn();
}

function showReviewHeader(title='주문 검토'){
  reviewHeader.textContent = title;
  reviewHeader.style.display = 'block';
}
function removeConfirmBtn(){ const c = $('#confirmBtn'); if (c) c.remove(); }
function injectConfirmBtn(){
  removeConfirmBtn();
  const wrap = document.createElement('div');
  wrap.className = 'btn-wrap';
  wrap.style.marginTop = '8px';
  const btn2 = document.createElement('button');
  btn2.id = 'confirmBtn';
  btn2.type = 'button';
  btn2.className = 'btn-resp';
  btn2.textContent = '확인 및 주문하기';
  btn2.addEventListener('click', submitFinal);
  wrap.appendChild(btn2);
  result.appendChild(wrap);
}

function enterReview(){
  mode = 'review';
  btn.textContent = '주문 수정하기';
  setBuyerDisabled(true);
  setItemsDisabled(true);
  showReviewHeader('주문 검토');
}
function enterEdit(){
  mode = 'edit';
  btn.textContent = '주문 검토하기';
  setBuyerDisabled(false);
  setItemsDisabled(false);
  reviewHeader.style.display = 'none';
  result.innerHTML = '';
  removeConfirmBtn();
  window.scrollTo({ top:0, behavior:'smooth' });
}

/* ===== 제출 ===== */
async function submitFinal(){
  if (submitting) return;

  const payload = buildPayload();
  const vReq = validateRequired(payload);
  if (!vReq.ok) { alert(vReq.msg); return; }

  openModalHTML('주문 접수 중입니다… 잠시만 기다려 주세요.');

  const cbtn = $('#confirmBtn');
  submitting = true;
  if (cbtn) cbtn.disabled = true;
  btn.disabled = true;
  out.textContent = '최종 주문 전송 중…';

  try{
    const body = {
      ...payload,
      _validated: lastValidated || null,
      _client: { ts: Date.now(), ua: navigator.userAgent },
      _notify: {
        customer: { send: true },
        admin:    { send: true, email: ADMIN_EMAIL, mode: 'summary' }
      }
    };

    const res = await fetch(SUBMIT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body),
    });

    const data = await res.json().catch(()=>null);
    out.textContent = JSON.stringify(data || { status: res.status }, null, 2);

    const ok = (data && (data.ok === true || data.status === 'ok')) || res.ok;

    if (ok){
      showReviewHeader('주문 완료');
      const sheetUrl = data?.sheet?.url;
      const totalTxt = (data?.summary?.grand_total != null)
        ? `총 결제금액: ${(Number(data.summary.grand_total)||0).toLocaleString('ko-KR')}원`
        : '';

      let html = '주문이 접수되었습니다. 확인 이메일이 곧 발송됩니다.';
      if (totalTxt) html += `<br><small>${totalTxt}</small>`;
      if (sheetUrl) html += `<br><br><a href="${sheetUrl}" target="_blank" rel="noreferrer">구글 시트에서 주문 확인하기</a>`;

      openModalHTML(html);
      if (cbtn) cbtn.disabled = true;
    }else{
      showReviewHeader('주문 실패');
      openModalHTML('주문 접수 중 문제가 발생했습니다. 잠시 후 다시 시도해 주세요.');
      btn.disabled = false;
      if (cbtn) cbtn.disabled = false;
    }
  }catch(e){
    out.textContent = '최종 전송 실패: ' + e;
    openModalHTML('네트워크 오류가 발생했습니다. 다시 시도해 주세요.');
    btn.disabled = false;
    const cbtn2 = $('#confirmBtn'); if (cbtn2) cbtn2.disabled = false;
  }finally{
    submitting = false;
  }
}

/* ===== 검토 ===== */
async function doValidate(){
  const payload = buildPayload();
  const vReq = validateRequired(payload);
  if (!vReq.ok) { alert(vReq.msg); return; }

  out.textContent = '검토 요청 중…';
  btn.disabled = true;
  try{
    const res = await fetch(VALIDATE_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>null);
    if(!data){ out.textContent = `서버가 JSON을 주지 않았습니다.\nstatus=${res.status}`; btn.disabled=false; return; }
    out.textContent = j(data);
    lastValidated = data;
    renderOrderCard(data);
    enterReview();
  }catch(e){
    out.textContent = '검토 요청 실패: ' + e;
  }finally{
    btn.disabled = false;
  }
}

btn.addEventListener('click', () => { if (mode === 'review') enterEdit(); else doValidate(); });

(function init(){ initItems(); })();
</script>
